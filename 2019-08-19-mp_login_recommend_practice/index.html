<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Colynn.Liu"><link rel=next href=https://colynn.github.io/2019-09-26-pycharm_env_setting/><link rel=canonical href=https://colynn.github.io/2019-08-19-mp_login_recommend_practice/><link rel=apple-touch-icon sizes=180x180 href=/img/favicon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>小程序实践归档 | Colynn.Liu</title><meta name=title content="小程序实践归档 | Colynn.Liu"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/colynn.github.io\/"},"articleSection":"posts","name":"小程序实践归档","headline":"小程序实践归档","description":"登录-推荐实践 登录-实现原则 小程序与开发服务器端通过 3rd_session（第三方session）【即自定义登录状态】来实现通信，微信官方也","inLanguage":"zh-CN","author":"Colynn.Liu","creator":"Colynn.Liu","publisher":"Colynn.Liu","accountablePerson":"Colynn.Liu","copyrightHolder":"Colynn.Liu","copyrightYear":"2018","datePublished":"2018-03-15 00:00:00 \u002b0000 UTC","dateModified":"2018-03-15 00:00:00 \u002b0000 UTC","url":"https:\/\/colynn.github.io\/2019-08-19-mp_login_recommend_practice\/","wordCount":"743","keywords":["小程序","Colynn.Liu"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=https://colynn.github.io/>Colynn.Liu</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>文章</a>
<a class=menu-item href=/categories/>分类</a>
<a class=menu-item href=/tags/>标签</a>
<a class=menu-item href=/aboutme/>关于我</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=https://colynn.github.io/>Colynn.Liu</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>文章</a>
<a class=menu-item href=/categories/>分类</a>
<a class=menu-item href=/tags/>标签</a>
<a class=menu-item href=/aboutme/>关于我</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">小程序实践归档</h1><div class=post-meta>Written by <a itemprop=name href=https://colynn.github.io/ rel=author>Colynn.Liu</a> with ♥
<span class=post-time>on <time datetime=2018-03-15 itemprop=datePublished>March 15, 2018</time></span>
<span class=post-time>- last modified <time datetime=2018-03-15 itemprop=datePublished>March 15, 2018</time></span></div><div class=post-tags><section><span class=tag><a href=https://colynn.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/><i class="iconfont icon-tag"></i>小程序</a></span></section><section></section></div></header><div class=post-content><h3 id=登录-推荐实践>登录-推荐实践</h3><p><img src=https://user-images.githubusercontent.com/5203608/89495221-67157500-d7ea-11ea-8333-f55edfb8b873.png alt=image></p><h3 id=登录-实现原则>登录-实现原则</h3><ul><li>小程序与开发服务器端通过 3rd_session（第三方session）【即自定义登录状态】来实现通信，微信官方也不建议直接通过openid/session_key来通信；</li></ul><p><em>原因</em>： openid是微信用户的唯一标识，直接用于传参通信的话，会存在被第三方组织截获的风险，进而用于其他用途，
如本地模拟请求，使用截获的openid作为传参，从而就可以伪装成相应的人。</p><ul><li><p>会话 session_key 是对用户数据进行 加密签名 的密钥。为了应用自身的数据安全，开发者服务器不应该把会话密钥下发到小程序，也不应该对外提供这个密钥。</p></li><li><p>数据校验方式：通过调用接口（如 wx.getUserInfo）获取数据时，接口会同时返回 rawData、signature，其中 signature = sha1( rawData + session_key )
开发者将 signature、rawData 发送到开发者服务器进行校验。服务器利用用户对应的 session_key 使用相同的算法计算出签名 signature2 ，比对 signature 与 signature2 即可校验数据的完整性。
小程序登录判断依赖wx.checksession， 但对于自身的登录态也是需要维护的，当前没有想到一个比较完整的解决方案。</p></li></ul><h3 id=问题记录>问题记录</h3><ol><li><p>子组件的方法调用时没有生效，注意将方法调整至methods内， 示例代码：</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>    ......
    methods <span style=color:#333>=</span> {
        async addFavorites() {
            wepy.showToast({
                    title<span style=color:#333>:</span> <span style=background-color:#fff0f0>&#39;接口待完善&#39;</span>,
                    duration<span style=color:#333>:</span> <span style=color:#00d;font-weight:700>2000</span>
            });
        }
    }
    ....
</code></pre></div></li><li><p>绑定事件获取要操作的属性时均要通过<code>data-*</code>的形式来传值，示例代码：</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#333>&lt;</span>template<span style=color:#333>&gt;</span>
    <span style=color:#333>&lt;</span>view data<span style=color:#333>-</span>parent<span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;{{index}}&#34;</span> data<span style=color:#333>-</span>index<span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;{{current}}&#34;</span> <span style=color:red;background-color:#faa>@</span>tap.stop<span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;setChoice&#34;</span><span style=color:#333>&gt;</span>示例代码<span style=color:#333>&lt;</span><span style=color:red;background-color:#faa>/view&gt;</span>
<span style=color:#333>&lt;</span><span style=color:red;background-color:#faa>/template&gt;</span>

<span style=color:#333>&lt;</span>script<span style=color:#333>&gt;</span>

setChoice(event) {
        <span style=color:#080;font-weight:700>var</span> parent_id <span style=color:#333>=</span> event.currentTarget.dataset.parent; 
        <span style=color:#080;font-weight:700>var</span> index <span style=color:#333>=</span> event.currentTarget.dataset.index;
        ...
<span style=color:#333>&lt;</span><span style=color:red;background-color:#faa>/script&gt;</span>
</code></pre></div></li><li><p>小程序当前窗口高度获取（单位为rpx）</p><ul><li>获取高度</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>try</span> {
  <span style=color:#080;font-weight:700>const</span> res <span style=color:#333>=</span> wx.getSystemInfoSync()
  console.log(res.model)
  console.log(res.pixelRatio)
  console.log(res.screenWidth)
  console.log(res.screenHeight)
  console.log(res.language)
  console.log(res.version)
  console.log(res.platform)

  <span style=color:#080;font-weight:700>var</span> clientHeight<span style=color:#333>=</span>res.screenHeight,
      clientWidth<span style=color:#333>=</span>res.screenWidth,
      rpxR<span style=color:#333>=</span><span style=color:#00d;font-weight:700>750</span><span style=color:#333>/</span>clientWidth;
  <span style=color:#080;font-weight:700>var</span> calc<span style=color:#333>=</span>clientHeight<span style=color:#333>*</span>rpxR;
  console.log(<span style=background-color:#fff0f0>&#39;SystemScreenHeight: &#39;</span> <span style=color:#333>+</span> calc)
  wepy.setStorageSync(<span style=background-color:#fff0f0>&#39;SystemScreenHeight&#39;</span>, calc)
} <span style=color:#080;font-weight:700>catch</span> (e) {
  console.log(<span style=background-color:#fff0f0>&#34;获取系统信息失败，使用默认高度&#34;</span>)
  wepy.setStorageSync(<span style=background-color:#fff0f0>&#39;SystemScreenHeight&#39;</span>, <span style=color:#00d;font-weight:700>1026</span>)
  <span style=color:#888>// Do something when catch error
</span><span style=color:#888></span>}
</code></pre></div><ul><li>使用高度</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#080;font-weight:700>var</span> winHeight <span style=color:#333>=</span> wepy.getStorageSync(<span style=background-color:#fff0f0>&#39;SystemScreenHeight&#39;</span>);
</code></pre></div></li></ol></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Colynn.Liu</span></p><p class=copyright-item><span>Link:</span>
<a href=https://colynn.github.io/2019-08-19-mp_login_recommend_practice/>https://colynn.github.io/2019-08-19-mp_login_recommend_practice/</span></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://colynn.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/>#小程序</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://colynn.github.io/>home</a></span></section></div><div class=post-nav><a href=https://colynn.github.io/2019-09-26-pycharm_env_setting/ class=next rel=next title="PyCharm 开发环境设置">PyCharm 开发环境设置&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script src=https://utteranc.es/client.js repo=colynn/blog-comments issue-term=pathname label=utterances theme=github-light crossorigin=anonymous async></script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2018 - 2020</span>
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://colynn.github.io/>Colynn.Liu</a> |</span>
<span><a href=https://colynn.github.io/friends>友情链接</a></span></div></footer><link href=//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css rel=stylesheet><script src=/js/vendor_gallery.min.js async></script></div></body></html>